import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible'
import { ChevronDown, Search, Filter, X, Download, RefreshCw, Eye, AlertTriangle, CheckCircle, Clock, Users, Calendar, Shield } from 'lucide-react'

export interface FilterState {
  search: string
  severity: string[]
  source: string[]
  status: string[]
  asset: string[]
  subAsset: string[]
  project: string[]
  category: string[]
  tenant: string
  perPage: number
  currentPage: number
  cvssRange: string
  dateRange: string
  assignee: string[]
  hasCVE: boolean
}

interface VulnerabilityFiltersProps {
  onFilterChange: (filters: FilterState) => void
  onReset: () => void
  onBulkAction: (action: string) => void
  selectedCount: number
  filteredCount: number
  totalCount: number
  activeSection: string
}

export function VulnerabilityFilters({
  onFilterChange,
  onReset,
  onBulkAction,
  selectedCount,
  filteredCount,
  totalCount,
  activeSection,
}: VulnerabilityFiltersProps) {
  const [filters, setFilters] = useState<FilterState>({
    search: '',
    severity: [],
    source: [],
    status: [],
    asset: [],
    subAsset: [],
    project: [],
    category: [],
    tenant: 'all',
    perPage: 20,
    currentPage: 1,
    cvssRange: 'all',
    dateRange: 'all',
    assignee: [],
    hasCVE: false,
  })

  const [expandedSections, setExpandedSections] = useState({
    quickFilters: true,
    basic: false,
    advanced: false,
    assignment: false,
  })

  // Filter options with counts - contextual based on activeSection
  const getSeverityOptions = () => {
    if (activeSection === 'offsec') {
      return [
        { value: 'Critical', label: 'Critical', color: 'destructive', count: 2 },
        { value: 'High', label: 'High', color: 'destructive', count: 3 },
        { value: 'Medium', label: 'Medium', color: 'default', count: 0 },
        { value: 'Low', label: 'Low', color: 'secondary', count: 0 },
        { value: 'Info', label: 'Info', color: 'secondary', count: 0 },
      ]
    } else if (activeSection === 'appsec') {
      return [
        { value: 'Critical', label: 'Critical', color: 'destructive', count: 5 },
        { value: 'High', label: 'High', color: 'destructive', count: 5 },
        { value: 'Medium', label: 'Medium', color: 'default', count: 6 },
        { value: 'Low', label: 'Low', color: 'secondary', count: 3 },
        { value: 'Info', label: 'Info', color: 'secondary', count: 1 },
      ]
    } else {
      return [
        { value: 'Critical', label: 'Critical', color: 'destructive', count: 7 },
        { value: 'High', label: 'High', color: 'destructive', count: 8 },
        { value: 'Medium', label: 'Medium', color: 'default', count: 6 },
        { value: 'Low', label: 'Low', color: 'secondary', count: 3 },
        { value: 'Info', label: 'Info', color: 'secondary', count: 1 },
      ]
    }
  }

  const getSourceOptions = () => {
    if (activeSection === 'offsec') {
      return [
        { value: 'manual_vapt', label: 'Manual VAPT', count: 5 },
        { value: 'asset_scan', label: 'Asset Scan', count: 0 },
      ]
    } else if (activeSection === 'appsec') {
      return [
        { value: 'snyk_sca', label: 'Snyk SCA', count: 6 },
        { value: 'snyk_sast', label: 'Snyk SAST', count: 5 },
        { value: 'snyk_dast', label: 'Snyk DAST', count: 5 },
      ]
    } else {
      return [
        { value: 'snyk_sca', label: 'Snyk SCA', count: 6 },
        { value: 'snyk_sast', label: 'Snyk SAST', count: 5 },
        { value: 'snyk_dast', label: 'Snyk DAST', count: 7 },
        { value: 'manual_vapt', label: 'Manual VAPT', count: 7 },
        { value: 'asset_scan', label: 'Asset Scan', count: 0 },
      ]
    }
  }

  const getAssetOptions = () => {
    if (activeSection === 'offsec') {
      return [
        { value: 'prod-api-01', label: 'Production API Server 01', count: 2 },
        { value: 'user-service', label: 'User Service', count: 1 },
        { value: 'content-server', label: 'Content Server', count: 1 },
        { value: 'admin-panel', label: 'Admin Panel', count: 1 },
      ]
    } else if (activeSection === 'appsec') {
      return [
        { value: 'prod-api-01', label: 'Production API Server 01', count: 3 },
        { value: 'prod-api-02', label: 'Production API Server 02', count: 1 },
        { value: 'web-server-02', label: 'Web Server 02', count: 1 },
        { value: 'db-primary', label: 'Primary Database', count: 1 },
        { value: 'staging-db', label: 'Staging Database', count: 1 },
        { value: 'auth-service', label: 'Authentication Service', count: 3 },
        { value: 'web-portal', label: 'Web Portal', count: 2 },
        { value: 'data-processor', label: 'Data Processor', count: 1 },
        { value: 'file-server', label: 'File Server', count: 1 },
        { value: 'database-primary', label: 'Database Primary', count: 1 },
        { value: 'token-service', label: 'Token Service', count: 1 },
      ]
    } else {
      return [
        { value: 'prod-api-01', label: 'Production API Server 01', count: 5 },
        { value: 'prod-api-02', label: 'Production API Server 02', count: 1 },
        { value: 'web-server-02', label: 'Web Server 02', count: 1 },
        { value: 'db-primary', label: 'Primary Database', count: 1 },
        { value: 'staging-db', label: 'Staging Database', count: 1 },
        { value: 'auth-service', label: 'Authentication Service', count: 3 },
        { value: 'web-portal', label: 'Web Portal', count: 2 },
        { value: 'data-processor', label: 'Data Processor', count: 1 },
        { value: 'load-balancer', label: 'Load Balancer', count: 1 },
        { value: 'api-gateway', label: 'API Gateway', count: 2 },
        { value: 'file-server', label: 'File Server', count: 1 },
        { value: 'content-server', label: 'Content Server', count: 1 },
        { value: 'admin-panel', label: 'Admin Panel', count: 1 },
        { value: 'reporting-service', label: 'Reporting Service', count: 1 },
        { value: 'database-primary', label: 'Database Primary', count: 1 },
        { value: 'reporting-engine', label: 'Reporting Engine', count: 1 },
        { value: 'token-service', label: 'Token Service', count: 1 },
      ]
    }
  }

  const cvssRangeOptions = [
    { value: 'all', label: 'All CVSS Scores' },
    { value: 'critical', label: 'Critical (9.0-10.0)' },
    { value: 'high', label: 'High (7.0-8.9)' },
    { value: 'medium', label: 'Medium (4.0-6.9)' },
    { value: 'low', label: 'Low (0.1-3.9)' },
  ]

  const dateRangeOptions = [
    { value: 'all', label: 'All Time' },
    { value: 'today', label: 'Today' },
    { value: 'week', label: 'This Week' },
    { value: 'month', label: 'This Month' },
    { value: 'quarter', label: 'This Quarter' },
  ]

  const statusOptions = [
    { value: 'open', label: 'Open', icon: AlertTriangle, count: 15 },
    { value: 'in_progress', label: 'In Progress', icon: Clock, count: 6 },
    { value: 'fixed', label: 'Fixed', icon: CheckCircle, count: 3 },
    { value: 'accepted', label: 'Accepted', icon: CheckCircle, count: 1 },
    { value: 'ignored', label: 'Ignored', icon: X, count: 0 },
  ]

  const categoryOptions = [
    { value: 'appsec', label: 'Application Security', icon: Shield, count: 16 },
    { value: 'offsec', label: 'Offensive Security', icon: Eye, count: 5 },
    { value: 'infra', label: 'Infrastructure', count: 2 },
    { value: 'compliance', label: 'Compliance', count: 2 },
  ]

  const tenantOptions = [
    { value: 'all', label: 'All Environments', count: 25 },
    { value: 'production', label: 'Production', count: 8 },
    { value: 'staging', label: 'Staging', count: 1 },
    { value: 'development', label: 'Development', count: 10 },
    { value: 'testing', label: 'Testing', count: 6 },
  ]

  // Toggle functions
  const toggleFilter = (category: keyof FilterState, value: string) => {
    const currentValues = filters[category] as string[]
    const newValues = currentValues.includes(value)
      ? currentValues.filter((v) => v !== value)
      : [...currentValues, value]
    
    const newFilters = { ...filters, [category]: newValues, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleSearchChange = (value: string) => {
    const newFilters = { ...filters, search: value, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleSelectChange = (category: keyof FilterState, value: string) => {
    const newFilters = { ...filters, [category]: value, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleReset = () => {
    setFilters({
      search: '',
      severity: [],
      source: [],
      status: [],
      asset: [],
      subAsset: [],
      project: [],
      category: [],
      tenant: 'all',
      perPage: 20,
      currentPage: 1,
      cvssRange: 'all',
      dateRange: 'all',
      assignee: [],
      hasCVE: false,
    })
    onReset()
  }

  const toggleSection = (section: string) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section as keyof typeof expandedSections]
    }))
  }

  const activeFilterCount =
    filters.severity.length +
    filters.source.length +
    filters.status.length +
    filters.asset.length +
    filters.subAsset.length +
    filters.project.length +
    filters.category.length +
    filters.assignee.length +
    (filters.search ? 1 : 0) +
    (filters.tenant !== 'all' ? 1 : 0) +
    (filters.cvssRange !== 'all' ? 1 : 0) +
    (filters.dateRange !== 'all' ? 1 : 0) +
    (filters.hasCVE ? 1 : 0)

  const applyQuickFilter = (type: string) => {
    let newFilters = { ...filters, currentPage: 1 }
    
    if (type === 'snyk') {
      newFilters.source = ['snyk_sca', 'snyk_sast', 'snyk_dast']
    } else if (type === 'manual') {
      newFilters.source = ['manual_vapt']
    } else if (type === 'critical') {
      newFilters.severity = ['Critical']
    } else if (type === 'open') {
      newFilters.status = ['open']
    } else if (type === 'recent') {
      newFilters.dateRange = 'week'
    }
    
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  return (
    <div className='space-y-4'>
      {/* Filter Header */}
      <Card>
        <CardHeader className='pb-3'>
          <div className='flex items-center justify-between'>
            <div className='flex items-center gap-2'>
              <Filter className='h-4 w-4' />
              <CardTitle className='text-lg font-semibold'>Filters</CardTitle>
              {activeFilterCount > 0 && (
                <Badge variant='secondary' className='text-xs'>
                  {activeFilterCount} active
                </Badge>
              )}
            </div>
            <div className='flex items-center gap-2'>
              <Button
                variant='outline'
                size='sm'
                onClick={handleReset}
                className='text-xs'
              >
                <X className='h-3 w-3 mr-1' />
                Reset
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent className='pt-0'>
          {/* Quick Actions */}
          <div className='flex flex-wrap gap-2 pb-3'>
            <Button
              variant='outline'
              size='sm'
              onClick={() => applyQuickFilter('snyk')}
              className='text-xs'
            >
              ü§ñ Snyk Scans
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => applyQuickFilter('manual')}
              className='text-xs'
            >
              üîç Manual VAPT
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => applyQuickFilter('critical')}
              className='text-xs'
            >
              ‚ö†Ô∏è Critical Only
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => applyQuickFilter('open')}
              className='text-xs'
            >
              üìã Open Issues
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => applyQuickFilter('recent')}
              className='text-xs'
            >
              üìÖ This Week
            </Button>
          </div>
          
          {/* Search */}
          <div className='relative'>
            <Search className='absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground' />
            <Input
              placeholder='Search vulnerabilities...'
              value={filters.search}
              onChange={(e) => handleSearchChange(e.target.value)}
              className='pl-10 h-10'
            />
          </div>
        </CardContent>
      </Card>

      {/* Filter Categories */}
      <Card>
        <CardContent className='pt-6 space-y-4'>
          {/* Environment */}
          <Collapsible open={expandedSections.basic} onOpenChange={() => toggleSection('basic')}>
            <CollapsibleTrigger className='w-full'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <Shield className='h-4 w-4' />
                  <span className='font-medium'>Environment</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.basic ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='space-y-3 pt-3'>
              <div className='grid grid-cols-2 gap-2'>
                {tenantOptions.map((tenant) => (
                  <Button
                    key={tenant.value}
                    variant={filters.tenant === tenant.value ? 'default' : 'outline'}
                    size='sm'
                    onClick={() => handleSelectChange('tenant', tenant.value)}
                    className='justify-start text-xs h-8'
                  >
                    {tenant.label}
                    <Badge variant='secondary' className='ml-auto text-xs'>
                      {tenant.count}
                    </Badge>
                  </Button>
                ))}
              </div>
            </CollapsibleContent>
          </Collapsible>

          <Separator />

          {/* Severity & Status */}
          <Collapsible open={expandedSections.basic} onOpenChange={() => toggleSection('basic')}>
            <CollapsibleTrigger className='w-full'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <AlertTriangle className='h-4 w-4' />
                  <span className='font-medium'>Severity & Status</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.basic ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='space-y-4 pt-3'>
              {/* Severity */}
              <div>
                <label className='text-sm font-medium mb-2 block'>Severity</label>
                <div className='flex flex-wrap gap-2'>
                  {getSeverityOptions().map((severity) => (
                    <Button
                      key={severity.value}
                      variant={filters.severity.includes(severity.value) ? severity.color as any : 'outline'}
                      size='sm'
                      onClick={() => toggleFilter('severity', severity.value)}
                      className='text-xs h-8'
                    >
                      {severity.label}
                      <Badge variant='secondary' className='ml-1 text-xs'>
                        {severity.count}
                      </Badge>
                    </Button>
                  ))}
                </div>
              </div>
              
              {/* Status */}
              <div>
                <label className='text-sm font-medium mb-2 block'>Status</label>
                <div className='flex flex-wrap gap-2'>
                  {statusOptions.map((status) => (
                    <Button
                      key={status.value}
                      variant={filters.status.includes(status.value) ? 'default' : 'outline'}
                      size='sm'
                      onClick={() => toggleFilter('status', status.value)}
                      className='text-xs h-8'
                    >
                      {status.icon && <status.icon className='h-3 w-3 mr-1' />}
                      {status.label}
                      <Badge variant='secondary' className='ml-1 text-xs'>
                        {status.count}
                      </Badge>
                    </Button>
                  ))}
                </div>
              </div>
            </CollapsibleContent>
          </Collapsible>

          <Separator />

          {/* Source & Category */}
          <Collapsible open={expandedSections.advanced} onOpenChange={() => toggleSection('advanced')}>
            <CollapsibleTrigger className='w-full'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <Filter className='h-4 w-4' />
                  <span className='font-medium'>Source & Category</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.advanced ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='space-y-4 pt-3'>
              {/* Source */}
              <div>
                <label className='text-sm font-medium mb-2 block'>Scan Source</label>
                <div className='flex flex-wrap gap-2'>
                  {getSourceOptions().map((source) => (
                    <Button
                      key={source.value}
                      variant={filters.source.includes(source.value) ? 'default' : 'outline'}
                      size='sm'
                      onClick={() => toggleFilter('source', source.value)}
                      className='text-xs h-8'
                    >
                      {source.label}
                      <Badge variant='secondary' className='ml-1 text-xs'>
                        {source.count}
                      </Badge>
                    </Button>
                  ))}
                </div>
              </div>
              
              {/* Category */}
              <div>
                <label className='text-sm font-medium mb-2 block'>Category</label>
                <div className='flex flex-wrap gap-2'>
                  {categoryOptions.map((category) => (
                    <Button
                      key={category.value}
                      variant={filters.category.includes(category.value) ? 'default' : 'outline'}
                      size='sm'
                      onClick={() => toggleFilter('category', category.value)}
                      className='text-xs h-8'
                    >
                      {category.icon && <category.icon className='h-3 w-3 mr-1' />}
                      {category.label}
                      <Badge variant='secondary' className='ml-1 text-xs'>
                        {category.count}
                      </Badge>
                    </Button>
                  ))}
                </div>
              </div>

              {/* Asset Filter */}
              <div>
                <label className='text-sm font-medium mb-2 block'>Assets</label>
                <div className='flex flex-wrap gap-2'>
                  {getAssetOptions().map((asset) => (
                    <Button
                      key={asset.value}
                      variant={filters.asset.includes(asset.value) ? 'default' : 'outline'}
                      size='sm'
                      onClick={() => toggleFilter('asset', asset.value)}
                      className='text-xs h-8'
                    >
                      {asset.label}
                      <Badge variant='secondary' className='ml-1 text-xs'>
                        {asset.count}
                      </Badge>
                    </Button>
                  ))}
                </div>
              </div>
            </CollapsibleContent>
          </Collapsible>

          <Separator />

          {/* Advanced Filters */}
          <Collapsible open={expandedSections.advanced} onOpenChange={() => toggleSection('advanced')}>
            <CollapsibleTrigger className='w-full'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <Calendar className='h-4 w-4' />
                  <span className='font-medium'>Advanced Filters</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.advanced ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='space-y-4 pt-3'>
              {/* CVSS Range */}
              <div>
                <label className='text-sm font-medium mb-2 block'>CVSS Score Range</label>
                <select
                  value={filters.cvssRange}
                  onChange={(e) => handleSelectChange('cvssRange', e.target.value)}
                  className='w-full h-9 text-sm border rounded px-3'
                >
                  {cvssRangeOptions.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>

              {/* Date Range */}
              <div>
                <label className='text-sm font-medium mb-2 block'>Date Range</label>
                <select
                  value={filters.dateRange}
                  onChange={(e) => handleSelectChange('dateRange', e.target.value)}
                  className='w-full h-9 text-sm border rounded px-3'
                >
                  {dateRangeOptions.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>

              {/* CVE Filter */}
              <div className='flex items-center gap-2'>
                <input
                  type='checkbox'
                  checked={filters.hasCVE}
                  onChange={() => handleSelectChange('hasCVE', String(!filters.hasCVE))}
                  className='h-4 w-4 rounded border-gray-300'
                />
                <label className='text-sm'>Only show vulnerabilities with CVE IDs</label>
              </div>
            </CollapsibleContent>
          </Collapsible>
        </CardContent>
      </Card>

      {/* Action Buttons */}
      <Card>
        <CardHeader>
          <CardTitle className='text-base font-semibold'>Actions</CardTitle>
        </CardHeader>
        <CardContent className='space-y-3'>
          {/* Bulk Actions */}
          {selectedCount > 0 && (
            <div className='p-3 bg-blue-50 border border-blue-200 rounded-lg'>
              <div className='flex items-center justify-between mb-3'>
                <span className='text-sm font-medium text-blue-900'>
                  {selectedCount} vulnerabilities selected
                </span>
                <Button
                  variant='ghost'
                  size='sm'
                  onClick={() => onBulkAction('clear-selection')}
                  className='text-xs text-blue-600'
                >
                  Clear
                </Button>
              </div>
              <div className='flex flex-wrap gap-2'>
                <Button
                  size='sm'
                  onClick={() => onBulkAction('mark-in-progress')}
                  className='text-xs'
                >
                  <Clock className='h-3 w-3 mr-1' />
                  Mark In Progress
                </Button>
                <Button
                  size='sm'
                  onClick={() => onBulkAction('mark-fixed')}
                  className='text-xs'
                >
                  <CheckCircle className='h-3 w-3 mr-1' />
                  Mark Fixed
                </Button>
                <Button
                  size='sm'
                  onClick={() => onBulkAction('assign')}
                  className='text-xs'
                >
                  <Users className='h-3 w-3 mr-1' />
                  Assign
                </Button>
                <Button
                  variant='destructive'
                  size='sm'
                  onClick={() => onBulkAction('delete')}
                  className='text-xs'
                >
                  <X className='h-3 w-3 mr-1' />
                  Delete
                </Button>
              </div>
            </div>
          )}

          {/* Export Actions */}
          <div className='space-y-2'>
            <Button
              variant='outline'
              size='sm'
              onClick={() => onBulkAction('export-pdf')}
              className='w-full justify-start text-xs'
            >
              <Download className='h-3 w-3 mr-2' />
              Export to PDF
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => onBulkAction('export-csv')}
              className='w-full justify-start text-xs'
            >
              <Download className='h-3 w-3 mr-2' />
              Export to CSV
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => onBulkAction('export-json')}
              className='w-full justify-start text-xs'
            >
              <Download className='h-3 w-3 mr-2' />
              Export to JSON
            </Button>
          </div>

          {/* Refresh */}
          <Button
            variant='outline'
            size='sm'
            onClick={() => onBulkAction('refresh')}
            className='w-full justify-start text-xs'
          >
            <RefreshCw className='h-3 w-3 mr-2' />
            Refresh Data
          </Button>
        </CardContent>
      </Card>

      {/* Filter Summary */}
      <Card>
        <CardHeader>
          <CardTitle className='text-base font-semibold'>Filter Summary</CardTitle>
        </CardHeader>
        <CardContent>
          <div className='space-y-2 text-sm'>
            <div className='flex justify-between'>
              <span className='text-muted-foreground'>Total Vulnerabilities:</span>
              <span className='font-medium'>{totalCount}</span>
            </div>
            <div className='flex justify-between'>
              <span className='text-muted-foreground'>Filtered Results:</span>
              <span className='font-medium text-blue-600'>{filteredCount}</span>
            </div>
            <div className='flex justify-between'>
              <span className='text-muted-foreground'>Active Filters:</span>
              <span className='font-medium'>{activeFilterCount}</span>
            </div>
            <div className='flex justify-between'>
              <span className='text-muted-foreground'>Selected:</span>
              <span className='font-medium'>{selectedCount}</span>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
