import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible'
import { Checkbox } from '@/components/ui/checkbox'
import { Slider } from '@/components/ui/slider'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { 
  ChevronDown, 
  Search, 
  Filter, 
  X, 
  Download, 
  RefreshCw, 
  Eye, 
  AlertTriangle, 
  CheckCircle, 
  Clock, 
  Shield,
  Server,
  Database,
  Globe,
  Code,
  Bug,
  ShieldAlert,
  Target,
  Layers,
  Building,
  User,
  CalendarDays,
  Hash,
  TrendingUp
} from 'lucide-react'

export interface FilterState {
  search: string
  severity: string[]
  source: string[]
  status: string[]
  asset: string[]
  subAsset: string[]
  project: string[]
  category: string[]
  perPage: number
  currentPage: number
  cvssRange: [number, number]
  dateRange: string
  assignee: string[]
  hasCVE: boolean
  riskScore: [number, number]
  complianceFrameworks: string[]
}

interface VulnerabilityFiltersProps {
  currentFilters?: FilterState
  onFilterChange: (filters: FilterState) => void
  onReset: () => void
  onBulkAction: (action: string) => void
  vulnCounts?: {
    all: number
    snyk_sca: number
    snyk_sast: number
    snyk_dast: number
    manual_vapt: number
    asset_scan: number
  }
  severityCounts?: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
  statusCounts?: {
    open: number
    in_progress: number
    fixed: number
    accepted: number
    ignored: number
  }
  assetCounts?: Array<{ name: string; count: number }>
}

export function VulnerabilityFilters({
  currentFilters,
  onFilterChange,
  onReset,
  onBulkAction,
  vulnCounts = {
    all: 0,
    snyk_sca: 0,
    snyk_sast: 0,
    snyk_dast: 0,
    manual_vapt: 0,
    asset_scan: 0,
  },
  severityCounts = {
    critical: 0,
    high: 0,
    medium: 0,
    low: 0,
    info: 0,
  },
  statusCounts = {
    open: 0,
    in_progress: 0,
    fixed: 0,
    accepted: 0,
    ignored: 0,
  },
  assetCounts = [],
}: VulnerabilityFiltersProps) {
  const [filters, setFilters] = useState<FilterState>(
    currentFilters || {
      search: '',
      severity: [],
      source: [],
      status: [],
      asset: [],
      subAsset: [],
      project: [],
      category: [],
      perPage: 20,
      currentPage: 1,
      cvssRange: [0, 10],
      dateRange: 'all',
      assignee: [],
      hasCVE: false,
      riskScore: [0, 100],
      complianceFrameworks: [],
    }
  )

  // Update internal state when currentFilters prop changes
  useEffect(() => {
    if (currentFilters) {
      setFilters(currentFilters)
    }
  }, [currentFilters])

  const [expandedSections, setExpandedSections] = useState({
    search: true,
    severity: true,
    status: true,
    source: true,
    assets: true,
    cvss: false,
    risk: false,
    date: false,
    assignee: false,
    compliance: false,
    advanced: false,
  })

  // Toggle functions
  const toggleFilter = (category: keyof FilterState, value: string) => {
    const currentValues = filters[category] as string[]
    const newValues = currentValues.includes(value)
      ? currentValues.filter((v) => v !== value)
      : [...currentValues, value]
    
    const newFilters = { ...filters, [category]: newValues, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleRangeChange = (category: keyof FilterState, value: [number, number]) => {
    const newFilters = { ...filters, [category]: value, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleSearchChange = (value: string) => {
    const newFilters = { ...filters, search: value, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleSelectChange = (category: keyof FilterState, value: string) => {
    const newFilters = { ...filters, [category]: value, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleCheckboxChange = (category: keyof FilterState, checked: boolean) => {
    const newFilters = { ...filters, [category]: checked, currentPage: 1 }
    setFilters(newFilters)
    onFilterChange(newFilters)
  }

  const handleReset = () => {
    setFilters({
      search: '',
      severity: [],
      source: [],
      status: [],
      asset: [],
      subAsset: [],
      project: [],
      category: [],
      perPage: 20,
      currentPage: 1,
      cvssRange: [0, 10],
      dateRange: 'all',
      assignee: [],
      hasCVE: false,
      riskScore: [0, 100],
      complianceFrameworks: [],
    })
    onReset()
  }

  const toggleSection = (section: string) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section as keyof typeof expandedSections]
    }))
  }

  const activeFilterCount =
    filters.severity.length +
    filters.source.length +
    filters.status.length +
    filters.asset.length +
    filters.subAsset.length +
    filters.project.length +
    filters.category.length +
    filters.assignee.length +
    filters.complianceFrameworks.length +
    (filters.search ? 1 : 0) +
    (filters.cvssRange[0] !== 0 || filters.cvssRange[1] !== 10 ? 1 : 0) +
    (filters.riskScore[0] !== 0 || filters.riskScore[1] !== 100 ? 1 : 0) +
    (filters.dateRange !== 'all' ? 1 : 0) +
    (filters.hasCVE ? 1 : 0)

  // Filter options - with dynamic counts from props
  const severityOptions = [
    { value: 'Critical', label: 'Critical', color: 'destructive', count: severityCounts.critical, icon: AlertTriangle },
    { value: 'High', label: 'High', color: 'destructive', count: severityCounts.high, icon: ShieldAlert },
    { value: 'Medium', label: 'Medium', color: 'default', count: severityCounts.medium, icon: AlertTriangle },
    { value: 'Low', label: 'Low', color: 'secondary', count: severityCounts.low, icon: Shield },
    { value: 'Info', label: 'Info', color: 'secondary', count: severityCounts.info, icon: Eye },
  ]

  const statusOptions = [
    { value: 'open', label: 'Open', icon: AlertTriangle, count: statusCounts.open, color: 'destructive' },
    { value: 'in_progress', label: 'In Progress', icon: Clock, count: statusCounts.in_progress, color: 'default' },
    { value: 'fixed', label: 'Fixed', icon: CheckCircle, count: statusCounts.fixed, color: 'secondary' },
    { value: 'accepted', label: 'Accepted', icon: CheckCircle, count: statusCounts.accepted, color: 'secondary' },
    { value: 'ignored', label: 'Ignored', icon: X, count: statusCounts.ignored, color: 'secondary' },
  ]

  const sourceOptions = [
    { value: 'snyk_sca', label: 'Snyk SCA', count: vulnCounts.snyk_sca, icon: Code },
    { value: 'snyk_sast', label: 'Snyk SAST', count: vulnCounts.snyk_sast, icon: Bug },
    { value: 'snyk_dast', label: 'Snyk DAST', count: vulnCounts.snyk_dast, icon: Target },
    { value: 'manual_vapt', label: 'Manual VAPT', count: vulnCounts.manual_vapt, icon: Eye },
    { value: 'asset_scan', label: 'Asset Scan', count: vulnCounts.asset_scan, icon: Server },
  ]

  const assetOptions = assetCounts.map((asset) => ({
    value: asset.name,
    label: asset.name,
    count: asset.count,
    icon: Server,
  })).slice(0, 15)  // Limit to 15 assets for UI

  const assigneeOptions = [
    { value: 'john.doe@company.com', label: 'John Doe', count: 5 },
    { value: 'jane.smith@company.com', label: 'Jane Smith', count: 4 },
    { value: 'mike.wilson@company.com', label: 'Mike Wilson', count: 3 },
    { value: 'sarah.jones@company.com', label: 'Sarah Jones', count: 3 },
    { value: 'sam.wilson@company.com', label: 'Sam Wilson', count: 2 },
  ]

  const priorityOptions = [
    { value: 'critical', label: 'Critical Priority', count: 5 },
    { value: 'high', label: 'High Priority', count: 8 },
    { value: 'medium', label: 'Medium Priority', count: 6 },
    { value: 'low', label: 'Low Priority', count: 3 },
  ]

  const complianceOptions = [
    { value: 'soc2', label: 'SOC 2', count: 8 },
    { value: 'iso27001', label: 'ISO 27001', count: 6 },
    { value: 'gdpr', label: 'GDPR', count: 4 },
    { value: 'pci_dss', label: 'PCI DSS', count: 3 },
    { value: 'hipaa', label: 'HIPAA', count: 2 },
  ]

  const dateRangeOptions = [
    { value: 'all', label: 'All Time' },
    { value: 'today', label: 'Today' },
    { value: 'week', label: 'This Week' },
    { value: 'month', label: 'This Month' },
    { value: 'quarter', label: 'This Quarter' },
    { value: 'year', label: 'This Year' },
  ]

  return (
    <div className='w-full overflow-y-auto bg-background'>
      {/* Filter Header */}
      <div className='sticky top-0 bg-background border-b p-3 z-10'>
        <div className='flex items-center justify-between mb-2'>
          <div className='flex items-center gap-2'>
            <Filter className='h-4 w-4' />
            <h3 className='font-semibold'>Filters</h3>
            {activeFilterCount > 0 && (
              <Badge variant='secondary' className='text-xs'>
                {activeFilterCount}
              </Badge>
            )}
          </div>
          <Button
            variant='outline'
            size='sm'
            onClick={handleReset}
            className='text-xs h-8'
          >
            <X className='h-3 w-3 mr-1' />
            Reset
          </Button>
        </div>
        
        {/* Search */}
        <div className='relative mt-2'>
          <Search className='absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground' />
          <Input
            placeholder='Search vulnerabilities...'
            value={filters.search}
            onChange={(e) => handleSearchChange(e.target.value)}
            className='pl-10 h-9 text-sm'
          />
        </div>
      </div>

      {/* Filter Sections */}
      <div className='p-3 space-y-2'>
        {/* Severity */}
        <Card>
          <Collapsible open={expandedSections.severity} onOpenChange={() => toggleSection('severity')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <AlertTriangle className='h-4 w-4 text-destructive' />
                  <span className='font-medium'>Severity</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.severity ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-2'>
                {severityOptions.map((severity) => (
                  <div key={severity.value} className='flex items-center space-x-2'>
                    <Checkbox
                      checked={filters.severity.includes(severity.value)}
                      onCheckedChange={() => toggleFilter('severity', severity.value)}
                    />
                    <div className='flex items-center justify-between flex-1'>
                      <div className='flex items-center gap-2'>
                        {severity.icon && <severity.icon className='h-3 w-3' />}
                        <span className='text-sm'>{severity.label}</span>
                      </div>
                      <Badge variant='secondary' className='text-xs'>
                        {severity.count}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* Status */}
        <Card>
          <Collapsible open={expandedSections.status} onOpenChange={() => toggleSection('status')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <Clock className='h-4 w-4 text-blue-600' />
                  <span className='font-medium'>Status</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.status ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-2'>
                {statusOptions.map((status) => (
                  <div key={status.value} className='flex items-center space-x-2'>
                    <Checkbox
                      checked={filters.status.includes(status.value)}
                      onCheckedChange={() => toggleFilter('status', status.value)}
                    />
                    <div className='flex items-center justify-between flex-1'>
                      <div className='flex items-center gap-2'>
                        {status.icon && <status.icon className='h-3 w-3' />}
                        <span className='text-sm'>{status.label}</span>
                      </div>
                      <Badge variant='secondary' className='text-xs'>
                        {status.count}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* Source */}
        <Card>
          <Collapsible open={expandedSections.source} onOpenChange={() => toggleSection('source')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <Target className='h-4 w-4 text-green-600' />
                  <span className='font-medium'>Source</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.source ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-2'>
                {sourceOptions.map((source) => (
                  <div key={source.value} className='flex items-center space-x-2'>
                    <Checkbox
                      checked={filters.source.includes(source.value)}
                      onCheckedChange={() => toggleFilter('source', source.value)}
                    />
                    <div className='flex items-center justify-between flex-1'>
                      <div className='flex items-center gap-2'>
                        {source.icon && <source.icon className='h-3 w-3' />}
                        <span className='text-sm'>{source.label}</span>
                      </div>
                      <Badge variant='secondary' className='text-xs'>
                        {source.count}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* Assets */}
        <Card>
          <Collapsible open={expandedSections.assets} onOpenChange={() => toggleSection('assets')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <Server className='h-4 w-4 text-purple-600' />
                  <span className='font-medium'>Assets</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.assets ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-2 max-h-48 overflow-y-auto'>
                {assetOptions.map((asset) => (
                  <div key={asset.value} className='flex items-center space-x-2'>
                    <Checkbox
                      checked={filters.asset.includes(asset.value)}
                      onCheckedChange={() => toggleFilter('asset', asset.value)}
                    />
                    <div className='flex items-center justify-between flex-1'>
                      <div className='flex items-center gap-2'>
                        {asset.icon && <asset.icon className='h-3 w-3' />}
                        <span className='text-sm'>{asset.label}</span>
                      </div>
                      <Badge variant='secondary' className='text-xs'>
                        {asset.count}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* CVSS Score Range - DISABLED */}
        <Card className='opacity-50 pointer-events-none'>
          <Collapsible open={expandedSections.cvss} onOpenChange={() => toggleSection('cvss')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <TrendingUp className='h-4 w-4 text-red-600' />
                  <span className='font-medium'>CVSS Score Range (Coming Soon)</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.cvss ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-4'>
                <div className='flex items-center justify-between'>
                  <span className='text-sm font-medium'>Score Range</span>
                  <span className='text-sm text-muted-foreground'>
                    {filters.cvssRange[0]} - {filters.cvssRange[1]}
                  </span>
                </div>
                <Slider
                  value={filters.cvssRange}
                  onValueChange={(value) => handleRangeChange('cvssRange', value as [number, number])}
                  max={10}
                  min={0}
                  step={0.1}
                  className='w-full'
                />
                <div className='flex justify-between text-xs text-muted-foreground'>
                  <span>0</span>
                  <span>10</span>
                </div>
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* Risk Score - DISABLED */}
        <Card className='opacity-50 pointer-events-none'>
          <Collapsible open={expandedSections.risk} onOpenChange={() => toggleSection('risk')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <ShieldAlert className='h-4 w-4 text-orange-600' />
                  <span className='font-medium'>Risk Score (Coming Soon)</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.risk ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-4'>
                <div className='flex items-center justify-between'>
                  <span className='text-sm font-medium'>Risk Range</span>
                  <span className='text-sm text-muted-foreground'>
                    {filters.riskScore[0]} - {filters.riskScore[1]}
                  </span>
                </div>
                <Slider
                  value={filters.riskScore}
                  onValueChange={(value) => handleRangeChange('riskScore', value as [number, number])}
                  max={100}
                  min={0}
                  step={1}
                  className='w-full'
                />
                <div className='flex justify-between text-xs text-muted-foreground'>
                  <span>Low</span>
                  <span>High</span>
                </div>
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* Date Range */}
        <Card>
          <Collapsible open={expandedSections.date} onOpenChange={() => toggleSection('date')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <CalendarDays className='h-4 w-4 text-blue-600' />
                  <span className='font-medium'>Date Range</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.date ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-4'>
                <Select value={filters.dateRange} onValueChange={(value) => handleSelectChange('dateRange', value)}>
                  <SelectTrigger className='w-full'>
                    <SelectValue placeholder='Select date range' />
                  </SelectTrigger>
                  <SelectContent>
                    {dateRangeOptions.map((option: any) => (
                      <SelectItem key={option.value} value={option.value}>
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* Assignee */}
        <Card>
          <Collapsible open={expandedSections.assignee} onOpenChange={() => toggleSection('assignee')}>
            <CollapsibleTrigger className='w-full p-3 hover:bg-accent rounded-t-lg'>
              <div className='flex items-center justify-between'>
                <div className='flex items-center gap-2'>
                  <User className='h-4 w-4 text-green-600' />
                  <span className='font-medium'>Assignee</span>
                </div>
                <ChevronDown className={`h-4 w-4 transition-transform ${expandedSections.assignee ? 'rotate-180' : ''}`} />
              </div>
            </CollapsibleTrigger>
            <CollapsibleContent className='px-3 pb-3'>
              <div className='space-y-2'>
                {assigneeOptions.map((assignee) => (
                  <div key={assignee.value} className='flex items-center space-x-2'>
                    <Checkbox
                      checked={filters.assignee.includes(assignee.value)}
                      onCheckedChange={() => toggleFilter('assignee', assignee.value)}
                    />
                    <div className='flex items-center justify-between flex-1'>
                      <span className='text-sm'>{assignee.label}</span>
                      <Badge variant='secondary' className='text-xs'>
                        {assignee.count}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            </CollapsibleContent>
          </Collapsible>
        </Card>

        {/* Action Buttons */}
        <Card>
          <CardContent className='pt-3 pb-3 space-y-2'>
            <Button
              variant='outline'
              size='sm'
              onClick={() => onBulkAction('export-pdf')}
              className='w-full justify-start'
            >
              <Download className='h-4 w-4 mr-2' />
              Export to PDF
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => onBulkAction('export-csv')}
              className='w-full justify-start'
            >
              <Download className='h-4 w-4 mr-2' />
              Export to CSV
            </Button>
            <Button
              variant='outline'
              size='sm'
              onClick={() => onBulkAction('refresh')}
              className='w-full justify-start'
            >
              <RefreshCw className='h-4 w-4 mr-2' />
              Refresh Data
            </Button>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
