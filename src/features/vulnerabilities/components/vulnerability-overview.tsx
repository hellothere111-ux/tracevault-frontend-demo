import { useMemo } from 'react'
import {
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  Area,
  AreaChart,
} from 'recharts'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { AlertTriangle, Shield, Zap } from 'lucide-react'
import type { Vulnerability } from '@/services/vulnerability.service'

interface TrendDataPoint {
  date: string
  critical: number
  high: number
  medium: number
  low: number
  info: number
}

interface VulnerabilityOverviewProps {
  data?: TrendDataPoint[]
  severityCounts?: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
  vulnerabilities?: Vulnerability[]
}

export function VulnerabilityOverview({
  data = [],
  severityCounts = { critical: 459, high: 594, medium: 297, low: 0, info: 0 },
}: VulnerabilityOverviewProps) {
  // Monthly trend data for vulnerabilities (discovered vs resolved)
  const monthlyTrendData = [
    { month: 'Jan', discovered: 45, resolved: 12, active: 198 },
    { month: 'Feb', discovered: 52, resolved: 15, active: 235 },
    { month: 'Mar', discovered: 38, resolved: 22, active: 251 },
    { month: 'Apr', discovered: 61, resolved: 28, active: 284 },
    { month: 'May', discovered: 49, resolved: 25, active: 308 },
    { month: 'Jun', discovered: 55, resolved: 31, active: 332 },
    { month: 'Jul', discovered: 67, resolved: 35, active: 364 },
    { month: 'Aug', discovered: 58, resolved: 38, active: 384 },
    { month: 'Sep', discovered: 72, resolved: 42, active: 414 },
    { month: 'Oct', discovered: 68, resolved: 45, active: 437 },
    { month: 'Nov', discovered: 74, resolved: 48, active: 463 },
    { month: 'Dec', discovered: 82, resolved: 52, active: 493 },
  ]

  // Calculate derived metrics
  const totalVulns =
    severityCounts.critical +
    severityCounts.high +
    severityCounts.medium +
    severityCounts.low +
    severityCounts.info

  const appSecCount = Math.round(totalVulns * 0.65)
  const offSecCount = Math.round(totalVulns * 0.35)
  const averageRiskScore = 7.2

  // Severity progression data for area chart
  const severityProgression = useMemo(() => {
    if (data && data.length > 0) return data
    return [
      { date: 'Jan 1', critical: 10, high: 45, medium: 120, low: 200, info: 50 },
      { date: 'Jan 2', critical: 12, high: 48, medium: 125, low: 210, info: 55 },
      { date: 'Jan 3', critical: 8, high: 42, medium: 118, low: 195, info: 48 },
      { date: 'Jan 4', critical: 15, high: 52, medium: 135, low: 220, info: 60 },
      { date: 'Jan 5', critical: 14, high: 50, medium: 132, low: 218, info: 58 },
      { date: 'Jan 6', critical: 11, high: 46, medium: 122, low: 205, info: 52 },
      { date: 'Jan 7', critical: 13, high: 49, medium: 128, low: 215, info: 56 },
    ]
  }, [data])

  const CustomTooltip = ({ active, payload }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className='bg-white p-3 rounded-lg border border-gray-200 shadow-lg text-gray-900 dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100'>
          <p className='font-semibold text-sm'>{payload[0]?.payload?.date || payload[0]?.payload?.week || payload[0]?.payload?.month}</p>
          {payload.map((entry: any, index: number) => (
            <p key={index} style={{ color: entry.color }} className='text-xs font-medium'>
              {entry.name}: {entry.value}
            </p>
          ))}
        </div>
      )
    }
    return null
  }

  return (
    <div className='space-y-4'>
      {/* Primary KPI Cards */}
      <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4'>
        {/* Total Vulnerabilities */}
        <Card>
          <CardHeader className='pb-3'>
            <CardTitle className='text-sm font-medium flex items-center gap-2'>
              <AlertTriangle className='h-4 w-4 text-red-600' />
              Total Issues
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className='text-3xl font-bold'>{totalVulns}</div>
            <div className='mt-2 space-y-1 text-xs'>
              <div className='flex justify-between'>
                <span className='text-muted-foreground'>Critical:</span>
                <span className='font-semibold text-red-600'>{severityCounts.critical}</span>
              </div>
              <div className='flex justify-between'>
                <span className='text-muted-foreground'>High:</span>
                <span className='font-semibold text-orange-600'>{severityCounts.high}</span>
              </div>
              <div className='flex justify-between'>
                <span className='text-muted-foreground'>Medium:</span>
                <span className='font-semibold text-yellow-600'>{severityCounts.medium}</span>
              </div>
              <div className='flex justify-between'>
                <span className='text-muted-foreground'>Low:</span>
                <span className='font-semibold text-blue-600'>{severityCounts.low}</span>
              </div>
              <div className='flex justify-between'>
                <span className='text-muted-foreground'>Info:</span>
                <span className='font-semibold text-green-600'>{severityCounts.info}</span>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* AppSec vs OffSec */}
        <Card>
          <CardHeader className='pb-3'>
            <CardTitle className='text-sm font-medium flex items-center gap-2'>
              <Shield className='h-4 w-4' />
              Category Split
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className='space-y-2'>
              <div>
                <div className='flex justify-between mb-1'>
                  <span className='text-xs font-medium'>üõ°Ô∏è AppSec</span>
                  <span className='text-sm font-bold text-blue-600'>{appSecCount}</span>
                </div>
                <div className='w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700'>
                  <div
                    className='bg-blue-600 h-2 rounded-full'
                    style={{ width: `${(appSecCount / totalVulns) * 100}%` }}
                  ></div>
                </div>
              </div>
              <div>
                <div className='flex justify-between mb-1'>
                  <span className='text-xs font-medium'>üéØ OffSec</span>
                  <span className='text-sm font-bold text-purple-600'>{offSecCount}</span>
                </div>
                <div className='w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700'>
                  <div
                    className='bg-purple-600 h-2 rounded-full'
                    style={{ width: `${(offSecCount / totalVulns) * 100}%` }}
                  ></div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Risk Score */}
        <Card>
          <CardHeader className='pb-3'>
            <CardTitle className='text-sm font-medium flex items-center gap-2'>
              <Zap className='h-4 w-4 text-yellow-600' />
              Average Risk
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className='text-3xl font-bold text-yellow-600'>{averageRiskScore}</div>
            <p className='text-xs text-muted-foreground mt-2'>
              on a scale of 0-10
            </p>
            <div className='mt-2 flex gap-1'>
              {[...Array(10)].map((_, i) => (
                <div
                  key={i}
                  className={`h-1 flex-1 rounded-full ${
                    i < Math.round(averageRiskScore) ? 'bg-yellow-600' : 'bg-gray-300'
                  }`}
                ></div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Total Engagements */}
        <Card>
          <CardHeader className='pb-3'>
            <CardTitle className='text-sm font-medium flex items-center gap-2'>
              <Shield className='h-4 w-4 text-blue-600' />
              Total Engagements
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className='text-3xl font-bold text-blue-600'>{Math.round(totalVulns * 0.15)}</div>
            <div className='mt-2 space-y-1 text-xs'>
              <div className='flex justify-between'>
                <span className='text-muted-foreground'>Active:</span>
                <span className='font-semibold text-blue-600'>{Math.round(totalVulns * 0.08)}</span>
              </div>
              <div className='flex justify-between'>
                <span className='text-muted-foreground'>Completed:</span>
                <span className='font-semibold text-green-600'>{Math.round(totalVulns * 0.07)}</span>
              </div>
            </div>
          </CardContent>
        </Card>


      </div>

      {/* Severity Trend & Monthly Trends */}
      <div className='grid grid-cols-1 lg:grid-cols-2 gap-4'>
        {/* Severity Trend Over Time */}
        <Card>
          <CardHeader>
            <CardTitle>Vulnerability Trend</CardTitle>
            <CardDescription>Severity breakdown over time</CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width='100%' height={350}>
              <AreaChart data={severityProgression}>
                <CartesianGrid strokeDasharray='3 3' stroke='#444' />
                <XAxis
                  dataKey='date'
                  stroke='#888888'
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                />
                <YAxis
                  stroke='#888888'
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                />
                <Tooltip content={<CustomTooltip />} />
                <Legend />
                <Area
                  type='monotone'
                  dataKey='critical'
                  stroke='#dc2626'
                  fill='#dc2626'
                  fillOpacity={0.3}
                  name='Critical'
                />
                <Area
                  type='monotone'
                  dataKey='high'
                  stroke='#f97316'
                  fill='#f97316'
                  fillOpacity={0.3}
                  name='High'
                />
                <Area
                  type='monotone'
                  dataKey='medium'
                  stroke='#eab308'
                  fill='#eab308'
                  fillOpacity={0.3}
                  name='Medium'
                />
                <Area
                  type='monotone'
                  dataKey='low'
                  stroke='#3b82f6'
                  fill='#3b82f6'
                  fillOpacity={0.3}
                  name='Low'
                />
              </AreaChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* Monthly Trends */}
        <Card>
          <CardHeader>
            <CardTitle>Monthly Trends</CardTitle>
            <CardDescription>Discovered vs Resolved vulnerabilities</CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width='100%' height={350}>
              <AreaChart data={monthlyTrendData}>
                <CartesianGrid strokeDasharray='3 3' stroke='#444' />
                <XAxis
                  dataKey='month'
                  stroke='#888888'
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                />
                <YAxis
                  stroke='#888888'
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                />
                <Tooltip content={<CustomTooltip />} />
                <Legend />
                <Area
                  type='monotone'
                  dataKey='discovered'
                  stroke='#ef4444'
                  fill='#ef4444'
                  fillOpacity={0.3}
                  name='Discovered'
                />
                <Area
                  type='monotone'
                  dataKey='resolved'
                  stroke='#10b981'
                  fill='#10b981'
                  fillOpacity={0.3}
                  name='Resolved'
                />
                <Area
                  type='monotone'
                  dataKey='active'
                  stroke='#f59e0b'
                  fill='#f59e0b'
                  fillOpacity={0.3}
                  name='Active'
                />
              </AreaChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
